{% extends 'base.html' %}

{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - Telegram Parser{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            <p class="text-muted">{{ period_name }}</p>
        </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="btn-group" role="group">
                <a href="?period=day" class="btn {% if period == 'day' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    –î–µ–Ω—å
                </a>
                <a href="?period=week" class="btn {% if period == 'week' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    –ù–µ–¥–µ–ª—è
                </a>
                <a href="?period=month" class="btn {% if period == 'month' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    –ú–µ—Å—è—Ü
                </a>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –∫–∞—á–µ—Å—Ç–≤–∞</h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <tbody>
                            <tr>
                                <td>–ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞</td>
                                <td class="text-end"><strong>{{ status_stats.none }}</strong></td>
                                <td class="text-end">
                                    {% if total_messages > 0 %}
                                    {% widthratio status_stats.none total_messages 100 %}%
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>–ù–µ–∫–≤–∞–ª</td>
                                <td class="text-end"><strong>{{ status_stats.unqualified }}</strong></td>
                                <td class="text-end">
                                    {% if total_messages > 0 %}
                                    {% widthratio status_stats.unqualified total_messages 100 %}%
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>–ö–≤–∞–ª</td>
                                <td class="text-end"><strong>{{ status_stats.qualified }}</strong></td>
                                <td class="text-end">
                                    {% if total_messages > 0 %}
                                    {% widthratio status_stats.qualified total_messages 100 %}%
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>–°–ø–∞–º</td>
                                <td class="text-end"><strong>{{ status_stats.spam }}</strong></td>
                                <td class="text-end">
                                    {% if total_messages > 0 %}
                                    {% widthratio status_stats.spam total_messages 100 %}%
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>–î–∏–∞–ª–æ–≥ –Ω–∞—á–∞—Ç</td>
                                <td class="text-end"><strong>{{ dialog_started }}</strong></td>
                                <td class="text-end">
                                    {% if total_messages > 0 %}
                                    {% widthratio dialog_started total_messages 100 %}%
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>–ü—Ä–æ–¥–∞–∂–∞</td>
                                <td class="text-end"><strong>{{ sale_made }}</strong></td>
                                <td class="text-end">
                                    {% if total_messages > 0 %}
                                    {% widthratio sale_made total_messages 100 %}%
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">–¢–æ–ø-10 –≥—Ä—É–ø–ø –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤</h5>
                </div>
                <div class="card-body">
                    {% if keyword_group_stats %}
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>–ì—Ä—É–ø–ø–∞</th>
                                <th class="text-end">–°–æ–æ–±—â–µ–Ω–∏–π</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in keyword_group_stats %}
                            <tr>
                                <td>{{ stat.keyword_group__name }}</td>
                                <td class="text-end"><strong>{{ stat.count }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ –¥–Ω—è–º -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üìà –î–∏–Ω–∞–º–∏–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π</h5>
                </div>
                <div class="card-body">
                    <canvas id="messagesChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('messagesChart').getContext('2d');
    
    const dailyStats = JSON.parse('{{ daily_stats_json|escapejs }}');
    const labels = dailyStats.map(stat => stat.date);
    const data = dailyStats.map(stat => stat.count);
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π',
                data: data,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}
