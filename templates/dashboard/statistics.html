{% extends 'base.html' %}

{% block title %}Статистика - Telegram Parser{% endblock %}

{% block extra_head %}
<style>
    .sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 25px !important;
    }
    
    .sortable:hover {
        background-color: rgba(0,0,0,0.05);
    }
    
    .sortable::after {
        content: '⇅';
        position: absolute;
        right: 8px;
        opacity: 0.3;
        font-size: 14px;
    }
    
    .sortable.asc::after {
        content: '▲';
        opacity: 0.8;
        color: #007bff;
    }
    
    .sortable.desc::after {
        content: '▼';
        opacity: 0.8;
        color: #007bff;
    }
    
    /* Кастомные кнопки периода */
    .btn-period {
        background-color: white;
        border-color: #d7dde3;
        color: #333;
    }
    
    .btn-period:hover {
        background-color: #f8f9fa;
        border-color: #d7dde3;
        color: #333;
    }
    
    .btn-period.active {
        background-color: #d7dde3;
        border-color: #d7dde3;
        color: #333;
    }
</style>
{% endblock %}

{% block content %}
<!-- Заголовок страницы -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2>Главная</h2>
            <div class="btn-group" role="group">
                <a href="?period=day" class="btn btn-period {% if period == 'day' %}active{% endif %}">
                    День
                </a>
                <a href="?period=week" class="btn btn-period {% if period == 'week' %}active{% endif %}">
                    Неделя
                </a>
                <a href="?period=month" class="btn btn-period {% if period == 'month' %}active{% endif %}">
                    Месяц
                </a>
            </div>
        </div>
    </div>
</div>

    <!-- Статистика по статусам -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Статистика по статусам качества</h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <tbody>
                            <tr class="table-primary">
                                <td><strong>Всего сообщений</strong></td>
                                <td class="text-end"><strong>{{ total_messages }}</strong></td>
                                <td class="text-end"><strong>100%</strong></td>
                            </tr>
                            <tr>
                                <td>Без статуса</td>
                                <td class="text-end"><strong>{{ status_stats.none }}</strong></td>
                                <td class="text-end">
                                    {% if total_messages > 0 %}
                                    {% widthratio status_stats.none total_messages 100 %}%
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>Неквал</td>
                                <td class="text-end"><strong>{{ status_stats.unqualified }}</strong></td>
                                <td class="text-end">
                                    {% if total_messages > 0 %}
                                    {% widthratio status_stats.unqualified total_messages 100 %}%
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>Квал</td>
                                <td class="text-end"><strong>{{ status_stats.qualified }}</strong></td>
                                <td class="text-end">
                                    {% if total_messages > 0 %}
                                    {% widthratio status_stats.qualified total_messages 100 %}%
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>Спам</td>
                                <td class="text-end"><strong>{{ status_stats.spam }}</strong></td>
                                <td class="text-end">
                                    {% if total_messages > 0 %}
                                    {% widthratio status_stats.spam total_messages 100 %}%
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>Диалог начат</td>
                                <td class="text-end"><strong>{{ dialog_started }}</strong></td>
                                <td class="text-end">
                                    {% if total_messages > 0 %}
                                    {% widthratio dialog_started total_messages 100 %}%
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>Продажа</td>
                                <td class="text-end"><strong>{{ sale_made }}</strong></td>
                                <td class="text-end">
                                    {% if total_messages > 0 %}
                                    {% widthratio sale_made total_messages 100 %}%
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Аналитика обработки сообщений</h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <tbody>
                            <tr class="table-primary">
                                <td><strong>Всего сообщений с ключевыми словами</strong></td>
                                <td class="text-end"><strong>{{ total_messages }}</strong></td>
                                <td class="text-end"><strong>100%</strong></td>
                            </tr>
                            <tr>
                                <td>Не требуют проверки ИИ</td>
                                <td class="text-end"><strong>{{ messages_without_ai }}</strong></td>
                                <td class="text-end">
                                    {% if total_messages > 0 %}
                                    {% widthratio messages_without_ai total_messages 100 %}%
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>Отклонено фильтром ИИ</td>
                                <td class="text-end"><strong>{{ ai_rejected }}</strong></td>
                                <td class="text-end">
                                    {% if total_messages > 0 %}
                                    {% widthratio ai_rejected total_messages 100 %}%
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>Прошли фильтр ИИ</td>
                                <td class="text-end"><strong>{{ ai_approved }}</strong></td>
                                <td class="text-end">
                                    {% if total_messages > 0 %}
                                    {% widthratio ai_approved total_messages 100 %}%
                                    {% endif %}
                                </td>
                            </tr>
                            <tr class="table-info">
                                <td><strong>Отправлено сообщений через sender</strong></td>
                                <td class="text-end"><strong>{{ sender_contacted }}</strong></td>
                                <td class="text-end">
                                    <strong>
                                    {% if total_messages > 0 %}
                                    {% widthratio sender_contacted total_messages 100 %}%
                                    {% endif %}
                                    </strong>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Детальная статистика по группам -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Детальная статистика по группам ключевых слов</h5>
                </div>
                <div class="card-body" id="groupStatsContainer">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-3 text-muted">Загрузка статистики по группам...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Детальная статистика по чатам -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Детальная статистика по чатам</h5>
                </div>
                <div class="card-body" id="chatStatsContainer">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-3 text-muted">Загрузка статистики по чатам...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- График по дням -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Динамика сообщений</h5>
                </div>
                <div class="card-body">
                    <canvas id="messagesChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
// Функция загрузки статистики по группам
function loadGroupStats(period) {
    fetch(`/statistics/groups/?period=${period}`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('groupStatsContainer');
            
            if (data.stats && data.stats.length > 0) {
                const html = `
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="groupStatsTable">
                            <thead>
                                <tr>
                                    <th class="sortable" data-column="0" data-type="text">Группа</th>
                                    <th class="text-end sortable" data-column="1" data-type="number">Всего</th>
                                    <th class="text-end sortable" data-column="2" data-type="number">Квал</th>
                                    <th class="text-end sortable" data-column="3" data-type="number">Неквал</th>
                                    <th class="text-end sortable" data-column="4" data-type="number">Спам</th>
                                    <th class="text-end sortable" data-column="5" data-type="number">Диалоги</th>
                                    <th class="text-end sortable" data-column="6" data-type="number">Продажи</th>
                                    <th class="text-end sortable" data-column="7" data-type="number">Эффективность</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.stats.map(group => `
                                    <tr>
                                        <td><strong>${group.name}</strong></td>
                                        <td class="text-end">${group.total}</td>
                                        <td class="text-end">${group.qualified}</td>
                                        <td class="text-end">${group.unqualified}</td>
                                        <td class="text-end">${group.spam}</td>
                                        <td class="text-end">${group.dialog}</td>
                                        <td class="text-end">${group.sale}</td>
                                        <td class="text-end">
                                            <span class="badge ${group.efficiency >= 50 ? 'bg-success' : group.efficiency >= 20 ? 'bg-warning' : 'bg-danger'}">
                                                ${group.efficiency}%
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                container.innerHTML = html;
                initTableSort('groupStatsTable', 1, 'desc');
            } else {
                container.innerHTML = '<p class="text-muted">Нет данных по группам за выбранный период</p>';
            }
        })
        .catch(error => {
            console.error('Error loading group stats:', error);
            document.getElementById('groupStatsContainer').innerHTML = '<p class="text-danger">Ошибка загрузки статистики</p>';
        });
}

// Функция загрузки статистики по чатам
function loadChatStats(period) {
    fetch(`/statistics/chats/?period=${period}`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('chatStatsContainer');
            
            if (data.stats && data.stats.length > 0) {
                const html = `
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="chatStatsTable">
                            <thead>
                                <tr>
                                    <th class="sortable" data-column="0" data-type="text">Чат</th>
                                    <th class="text-end sortable" data-column="1" data-type="number">Всего</th>
                                    <th class="text-end sortable" data-column="2" data-type="number">Квал</th>
                                    <th class="text-end sortable" data-column="3" data-type="number">Неквал</th>
                                    <th class="text-end sortable" data-column="4" data-type="number">Спам</th>
                                    <th class="text-end sortable" data-column="5" data-type="number">Диалоги</th>
                                    <th class="text-end sortable" data-column="6" data-type="number">Продажи</th>
                                    <th class="text-end sortable" data-column="7" data-type="number">Эффективность</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.stats.map(chat => `
                                    <tr>
                                        <td><strong>${chat.name}</strong></td>
                                        <td class="text-end">${chat.total}</td>
                                        <td class="text-end">${chat.qualified}</td>
                                        <td class="text-end">${chat.unqualified}</td>
                                        <td class="text-end">${chat.spam}</td>
                                        <td class="text-end">${chat.dialog}</td>
                                        <td class="text-end">${chat.sale}</td>
                                        <td class="text-end">
                                            <span class="badge ${chat.efficiency >= 50 ? 'bg-success' : chat.efficiency >= 20 ? 'bg-warning' : 'bg-danger'}">
                                                ${chat.efficiency}%
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                container.innerHTML = html;
                initTableSort('chatStatsTable', 1, 'desc');
            } else {
                container.innerHTML = '<p class="text-muted">Нет данных по чатам за выбранный период</p>';
            }
        })
        .catch(error => {
            console.error('Error loading chat stats:', error);
            document.getElementById('chatStatsContainer').innerHTML = '<p class="text-danger">Ошибка загрузки статистики</p>';
        });
}

// Функция сортировки таблиц
function initTableSort(tableId, defaultColumn = 1, defaultOrder = 'desc') {
    const table = document.getElementById(tableId);
    if (!table) return;
    
    const tbody = table.querySelector('tbody');
    const headers = table.querySelectorAll('.sortable');
    
    // Устанавливаем начальную сортировку (визуальный индикатор)
    const defaultHeader = Array.from(headers).find(h => parseInt(h.dataset.column) === defaultColumn);
    if (defaultHeader) {
        defaultHeader.classList.add(defaultOrder);
    }
    
    headers.forEach(header => {
        header.addEventListener('click', () => {
            const column = parseInt(header.dataset.column);
            const type = header.dataset.type;
            const isAsc = header.classList.contains('asc');
            
            // Убираем классы сортировки со всех заголовков
            headers.forEach(h => h.classList.remove('asc', 'desc'));
            
            // Добавляем класс к текущему заголовку
            header.classList.add(isAsc ? 'desc' : 'asc');
            
            // Получаем строки таблицы
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Сортируем строки
            rows.sort((a, b) => {
                let aValue, bValue;
                
                if (type === 'number') {
                    // Для числовых колонок берем текст и парсим число
                    const aText = a.cells[column].textContent.trim();
                    const bText = b.cells[column].textContent.trim();
                    
                    // Убираем % знак для процентов
                    aValue = parseFloat(aText.replace('%', '')) || 0;
                    bValue = parseFloat(bText.replace('%', '')) || 0;
                } else {
                    // Для текстовых колонок
                    aValue = a.cells[column].textContent.trim().toLowerCase();
                    bValue = b.cells[column].textContent.trim().toLowerCase();
                }
                
                if (aValue < bValue) return isAsc ? 1 : -1;
                if (aValue > bValue) return isAsc ? -1 : 1;
                return 0;
            });
            
            // Перестраиваем таблицу
            rows.forEach(row => tbody.appendChild(row));
        });
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const currentPeriod = '{{ period }}';
    
    // Загружаем статистику по группам
    loadGroupStats(currentPeriod);
    
    // Загружаем статистику по чатам
    loadChatStats(currentPeriod);
    
    // Инициализируем график
    const ctx = document.getElementById('messagesChart').getContext('2d');
    
    const dailyStats = JSON.parse('{{ daily_stats_json|escapejs }}');
    const labels = dailyStats.map(stat => stat.date);
    const data = dailyStats.map(stat => stat.count);
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Количество сообщений',
                data: data,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}
