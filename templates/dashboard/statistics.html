{% extends 'base.html' %}

{% block title %}Статистика - Telegram Parser{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2>Статистика</h2>
            <p class="text-muted">{{ period_name }}</p>
        </div>
    </div>

    <!-- Фильтр по периодам -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="btn-group" role="group">
                <a href="?period=day" class="btn {% if period == 'day' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    День
                </a>
                <a href="?period=week" class="btn {% if period == 'week' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    Неделя
                </a>
                <a href="?period=month" class="btn {% if period == 'month' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    Месяц
                </a>
            </div>
        </div>
    </div>

    <!-- Статистика по статусам -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Статистика по статусам качества</h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <tbody>
                            <tr>
                                <td>Без статуса</td>
                                <td class="text-end"><strong>{{ status_stats.none }}</strong></td>
                                <td class="text-end">
                                    {% if total_messages > 0 %}
                                    {% widthratio status_stats.none total_messages 100 %}%
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>Неквал</td>
                                <td class="text-end"><strong>{{ status_stats.unqualified }}</strong></td>
                                <td class="text-end">
                                    {% if total_messages > 0 %}
                                    {% widthratio status_stats.unqualified total_messages 100 %}%
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>Квал</td>
                                <td class="text-end"><strong>{{ status_stats.qualified }}</strong></td>
                                <td class="text-end">
                                    {% if total_messages > 0 %}
                                    {% widthratio status_stats.qualified total_messages 100 %}%
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>Спам</td>
                                <td class="text-end"><strong>{{ status_stats.spam }}</strong></td>
                                <td class="text-end">
                                    {% if total_messages > 0 %}
                                    {% widthratio status_stats.spam total_messages 100 %}%
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>Диалог начат</td>
                                <td class="text-end"><strong>{{ dialog_started }}</strong></td>
                                <td class="text-end">
                                    {% if total_messages > 0 %}
                                    {% widthratio dialog_started total_messages 100 %}%
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>Продажа</td>
                                <td class="text-end"><strong>{{ sale_made }}</strong></td>
                                <td class="text-end">
                                    {% if total_messages > 0 %}
                                    {% widthratio sale_made total_messages 100 %}%
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Топ-10 групп ключевых слов</h5>
                </div>
                <div class="card-body">
                    {% if keyword_group_stats %}
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Группа</th>
                                <th class="text-end">Сообщений</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in keyword_group_stats %}
                            <tr>
                                <td>{{ stat.keyword_group__name }}</td>
                                <td class="text-end"><strong>{{ stat.count }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-muted">Нет данных за выбранный период</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Детальная статистика по группам -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Детальная статистика по группам ключевых слов</h5>
                </div>
                <div class="card-body">
                    {% if detailed_group_stats %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Группа</th>
                                    <th class="text-end">Всего</th>
                                    <th class="text-end">Квал</th>
                                    <th class="text-end">Неквал</th>
                                    <th class="text-end">Спам</th>
                                    <th class="text-end">Диалоги</th>
                                    <th class="text-end">Продажи</th>
                                    <th class="text-end">Эффективность</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for group in detailed_group_stats %}
                                <tr>
                                    <td><strong>{{ group.name }}</strong></td>
                                    <td class="text-end">{{ group.total }}</td>
                                    <td class="text-end">{{ group.qualified }}</td>
                                    <td class="text-end">{{ group.unqualified }}</td>
                                    <td class="text-end">{{ group.spam }}</td>
                                    <td class="text-end">{{ group.dialog }}</td>
                                    <td class="text-end">{{ group.sale }}</td>
                                    <td class="text-end">
                                        <span class="badge {% if group.efficiency >= 50 %}bg-success{% elif group.efficiency >= 20 %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ group.efficiency }}%
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="alert alert-info mt-3">
                        <strong>Как оценить группу:</strong>
                        <ul class="mb-0">
                            <li><span class="badge bg-success">Зеленая</span> (≥50%) - отличная группа, много квалифицированных лидов</li>
                            <li><span class="badge bg-warning">Желтая</span> (20-49%) - средняя группа, можно оптимизировать</li>
                            <li><span class="badge bg-danger">Красная</span> (<20%) - низкая эффективность, стоит пересмотреть или удалить</li>
                        </ul>
                    </div>
                    {% else %}
                    <p class="text-muted">Нет данных по группам за выбранный период</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- График по дням -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Динамика сообщений</h5>
                </div>
                <div class="card-body">
                    <canvas id="messagesChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('messagesChart').getContext('2d');
    
    const dailyStats = JSON.parse('{{ daily_stats_json|escapejs }}');
    const labels = dailyStats.map(stat => stat.date);
    const data = dailyStats.map(stat => stat.count);
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Количество сообщений',
                data: data,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}
