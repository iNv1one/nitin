{% extends 'base.html' %}

{% block title %}–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è - NITIN{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-envelope-open-text"></i> –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (CRM)</h2>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">–ö–∞—á–µ—Å—Ç–≤–æ</label>
                        <select name="status" class="form-select">
                            <option value="">–í—Å–µ</option>
                            <option value="none" {% if status_filter == 'none' %}selected{% endif %}>‚ö™ –ù–µ–æ—Ç—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ</option>
                            <option value="qualified" {% if status_filter == 'qualified' %}selected{% endif %}>‚≠ê –ö–≤–∞–ª</option>
                            <option value="unqualified" {% if status_filter == 'unqualified' %}selected{% endif %}>‚ùå –ù–µ–∫–≤–∞–ª</option>
                            <option value="spam" {% if status_filter == 'spam' %}selected{% endif %}>üö´ –°–ø–∞–º</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">–î–∏–∞–ª–æ–≥/–ü—Ä–æ–¥–∞–∂–∞</label>
                        <select name="progress" class="form-select">
                            <option value="">–í—Å–µ</option>
                            <option value="dialog" {% if request.GET.progress == 'dialog' %}selected{% endif %}>üí¨ –î–∏–∞–ª–æ–≥ –Ω–∞—á–∞—Ç</option>
                            <option value="sale" {% if request.GET.progress == 'sale' %}selected{% endif %}>üí∞ –ï—Å—Ç—å –ø—Ä–æ–¥–∞–∂–∞</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">–ü–µ—Ä–∏–æ–¥</label>
                        <select name="date" class="form-select">
                            <option value="">–í—Å–µ –≤—Ä–µ–º—è</option>
                            <option value="today" {% if date_filter == 'today' %}selected{% endif %}>–°–µ–≥–æ–¥–Ω—è</option>
                            <option value="week" {% if date_filter == 'week' %}selected{% endif %}>–ù–µ–¥–µ–ª—è</option>
                            <option value="month" {% if date_filter == 'month' %}selected{% endif %}>–ú–µ—Å—è—Ü</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary d-block w-100">
                            <i class="fas fa-filter"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π -->
<div class="row">
    <div class="col-12">
        {% if page_obj %}
            {% for message in page_obj %}
            <div class="card mb-3 message-row status-{{ message.quality_status }}">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-7">
                            <h5 class="card-title">
                                –û—Ç: <strong>{{ message.sender_name|default:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ" }}</strong>
                                {% if message.sender_username %} (@{{ message.sender_username }}){% endif %}
                            </h5>
                            <p class="card-text">{{ message.message_text|truncatewords:50 }}</p>
                            <small class="text-muted">
                                <i class="fas fa-tags"></i> {{ message.matched_keywords_display }} | 
                                <i class="fas fa-clock"></i> {{ message.processed_at|date:"d.m.Y H:i" }}
                            </small>
                        </div>
                        <div class="col-md-5">
                            <div class="mb-2">
                                <strong>–°—Ç–∞—Ç—É—Å:</strong>
                                <div class="btn-group w-100 mb-2" role="group" aria-label="Quality status">
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-secondary {% if message.quality_status == 'unqualified' %}active{% endif %}"
                                            onclick="updateStatus({{ message.id }}, 'unqualified', this)">
                                        {% if message.quality_status == 'unqualified' %}‚úì{% endif %} –ù–µ–∫–≤–∞–ª
                                    </button>
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-secondary {% if message.quality_status == 'qualified' %}active{% endif %}"
                                            onclick="updateStatus({{ message.id }}, 'qualified', this)">
                                        {% if message.quality_status == 'qualified' %}‚úì{% endif %} –ö–≤–∞–ª
                                    </button>
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-secondary {% if message.quality_status == 'spam' %}active{% endif %}"
                                            onclick="updateStatus({{ message.id }}, 'spam', this)">
                                        {% if message.quality_status == 'spam' %}‚úì{% endif %} –°–ø–∞–º
                                    </button>
                                </div>
                                <div class="btn-group w-100 mb-2" role="group" aria-label="Progress status">
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-secondary {% if message.dialog_started %}active{% endif %}"
                                            onclick="updateProgress({{ message.id }}, 'dialog', {{ message.dialog_started|yesno:'true,false' }}, this)">
                                        {% if message.dialog_started %}‚úì{% endif %} –ù–∞—á–∞–ª–∏ –¥–∏–∞–ª–æ–≥
                                    </button>
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-secondary {% if message.sale_made %}active{% endif %}"
                                            onclick="updateProgress({{ message.id }}, 'sale', {{ message.sale_made|yesno:'true,false' }}, this)">
                                        {% if message.sale_made %}‚úì{% endif %} –ï—Å—Ç—å –ø—Ä–æ–¥–∞–∂–∞
                                    </button>
                                </div>
                            </div>
                            {% if message.message_link %}
                            <a href="{{ message.message_link }}" target="_blank" class="btn btn-sm btn-outline-primary w-100">
                                <i class="fas fa-external-link-alt"></i> –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> –ü–æ–∫–∞ –Ω–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            </div>
        {% endif %}
    </div>
</div>

<script>
function updateStatus(messageId, status, button) {
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
    fetch(`/dashboard/message/${messageId}/update-status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `quality_status=${status}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º UI - —Å–Ω–∏–º–∞–µ–º active —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –≤ –≥—Ä—É–ø–ø–µ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–∞ —Ç–µ–∫—É—â—É—é
            const btnGroup = button.parentElement;
            btnGroup.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('active');
                // –£–±–∏—Ä–∞–µ–º –≥–∞–ª–æ—á–∫—É
                btn.textContent = btn.textContent.replace('‚úì ', '');
            });
            // –î–æ–±–∞–≤–ª—è–µ–º active –∏ –≥–∞–ª–æ—á–∫—É –Ω–∞ —Ç–µ–∫—É—â—É—é –∫–Ω–æ–ø–∫—É
            button.classList.add('active');
            if (!button.textContent.startsWith('‚úì')) {
                button.textContent = '‚úì ' + button.textContent.trim();
            }
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
    });
}

function updateProgress(messageId, type, currentValue, button) {
    // Toggle –∑–Ω–∞—á–µ–Ω–∏–µ
    const newValue = !currentValue;
    const field = type === 'dialog' ? 'dialog_started' : 'sale_made';
    
    fetch(`/dashboard/message/${messageId}/update-status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `${field}=${newValue}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Toggle active –∫–ª–∞—Å—Å –∏ –≥–∞–ª–æ—á–∫—É
            if (newValue) {
                button.classList.add('active');
                if (!button.textContent.startsWith('‚úì')) {
                    button.textContent = '‚úì ' + button.textContent.trim();
                }
            } else {
                button.classList.remove('active');
                button.textContent = button.textContent.replace('‚úì ', '');
            }
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç onclick —Å –Ω–æ–≤—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
            button.setAttribute('onclick', `updateProgress(${messageId}, '${type}', ${newValue}, this)`);
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
