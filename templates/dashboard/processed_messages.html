{% extends 'base.html' %}

{% block title %}–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è - NITIN{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-envelope-open-text"></i> –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (CRM)</h2>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">–ö–∞—á–µ—Å—Ç–≤–æ</label>
                        <select name="status" class="form-select">
                            <option value="">–í—Å–µ</option>
                            <option value="none" {% if status_filter == 'none' %}selected{% endif %}>‚ö™ –ù–µ–æ—Ç—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ</option>
                            <option value="qualified" {% if status_filter == 'qualified' %}selected{% endif %}>‚≠ê –ö–≤–∞–ª</option>
                            <option value="unqualified" {% if status_filter == 'unqualified' %}selected{% endif %}>‚ùå –ù–µ–∫–≤–∞–ª</option>
                            <option value="spam" {% if status_filter == 'spam' %}selected{% endif %}>üö´ –°–ø–∞–º</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">–î–∏–∞–ª–æ–≥/–ü—Ä–æ–¥–∞–∂–∞</label>
                        <select name="progress" class="form-select">
                            <option value="">–í—Å–µ</option>
                            <option value="dialog" {% if request.GET.progress == 'dialog' %}selected{% endif %}>üí¨ –î–∏–∞–ª–æ–≥ –Ω–∞—á–∞—Ç</option>
                            <option value="sale" {% if request.GET.progress == 'sale' %}selected{% endif %}>üí∞ –ï—Å—Ç—å –ø—Ä–æ–¥–∞–∂–∞</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">–ü–µ—Ä–∏–æ–¥</label>
                        <select name="date" class="form-select">
                            <option value="">–í—Å–µ –≤—Ä–µ–º—è</option>
                            <option value="today" {% if date_filter == 'today' %}selected{% endif %}>–°–µ–≥–æ–¥–Ω—è</option>
                            <option value="week" {% if date_filter == 'week' %}selected{% endif %}>–ù–µ–¥–µ–ª—è</option>
                            <option value="month" {% if date_filter == 'month' %}selected{% endif %}>–ú–µ—Å—è—Ü</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary d-block w-100">
                            <i class="fas fa-filter"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π -->
<div class="row">
    <div class="col-12">
        {% if page_obj %}
            {% for message in page_obj %}
            <div class="card mb-3 message-row status-{{ message.quality_status }}">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="card-title">
                                –û—Ç: <strong>{{ message.sender_name|default:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ" }}</strong>
                                {% if message.sender_username %} (@{{ message.sender_username }}){% endif %}
                            </h5>
                            <p class="card-text">{{ message.message_text|truncatewords:50 }}</p>
                            <small class="text-muted">
                                <i class="fas fa-tags"></i> {{ message.matched_keywords_display }} | 
                                <i class="fas fa-clock"></i> {{ message.processed_at|date:"d.m.Y H:i" }}
                            </small>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-2">
                                <strong>–°—Ç–∞—Ç—É—Å:</strong>
                                <div class="btn-group d-flex mb-2" role="group">
                                    {% if message.quality_status == 'qualified' %}
                                        <span class="badge bg-success w-100">‚≠ê –ö–≤–∞–ª</span>
                                    {% elif message.quality_status == 'unqualified' %}
                                        <span class="badge bg-danger w-100">‚ùå –ù–µ–∫–≤–∞–ª</span>
                                    {% elif message.quality_status == 'spam' %}
                                        <span class="badge bg-dark w-100">üö´ –°–ø–∞–º</span>
                                    {% else %}
                                        <span class="badge bg-secondary w-100">‚ö™ –ù–æ–≤–æ–µ</span>
                                    {% endif %}
                                </div>
                                {% if message.dialog_started %}
                                    <span class="badge bg-info w-100 mb-1">üí¨ –ù–∞—á–∞–ª–∏ –¥–∏–∞–ª–æ–≥</span>
                                {% endif %}
                                {% if message.sale_made %}
                                    <span class="badge bg-warning text-dark w-100 mb-1">üí∞ –ï—Å—Ç—å –ø—Ä–æ–¥–∞–∂–∞</span>
                                {% endif %}
                            </div>
                            {% if message.message_link %}
                            <a href="{{ message.message_link }}" target="_blank" class="btn btn-sm btn-outline-primary w-100">
                                <i class="fas fa-external-link-alt"></i> –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> –ü–æ–∫–∞ –Ω–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}
