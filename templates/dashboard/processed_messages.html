{% extends 'base.html' %}

{% block title %}Обработанные сообщения - NITIN{% endblock %}

{% block extra_head %}
<style>
    /* Стили пагинации */
    .pagination .page-link {
        background-color: white;
        border-color: #d7dde3;
        color: #333;
    }
    
    .pagination .page-link:hover {
        background-color: #f8f9fa;
        border-color: #d7dde3;
        color: #333;
    }
    
    .pagination .page-item.active .page-link {
        background-color: #d7dde3;
        border-color: #d7dde3;
        color: #333;
        z-index: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2>Сообщения</h2>
            <div>
                <span class="badge bg-primary">Всего: {{ total_count }}</span>
                <span class="badge bg-success">Одобрено ИИ: {{ approved_count }}</span>
                <span class="badge bg-danger">Отклонено ИИ: {{ rejected_count }}</span>
                <button class="btn btn-sm btn-outline-secondary" onclick="location.reload()">
                    <i class="fas fa-sync-alt"></i> Обновить
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Фильтры -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label">Статус ИИ</label>
                        <select name="ai_status" class="form-select">
                            <option value="">Все</option>
                            <option value="approved" {% if ai_status_filter == 'approved' %}selected{% endif %}>Одобрено ИИ</option>
                            <option value="rejected" {% if ai_status_filter == 'rejected' %}selected{% endif %}>Отклонено ИИ</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Качество</label>
                        <select name="status" class="form-select">
                            <option value="">Все</option>
                            <option value="none" {% if status_filter == 'none' %}selected{% endif %}>Неотработанные</option>
                            <option value="qualified" {% if status_filter == 'qualified' %}selected{% endif %}>Квал</option>
                            <option value="unqualified" {% if status_filter == 'unqualified' %}selected{% endif %}>Неквал</option>
                            <option value="spam" {% if status_filter == 'spam' %}selected{% endif %}>Спам</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Диалог/Продажа</label>
                        <select name="progress" class="form-select">
                            <option value="">Все</option>
                            <option value="dialog" {% if request.GET.progress == 'dialog' %}selected{% endif %}>Диалог начат</option>
                            <option value="sale" {% if request.GET.progress == 'sale' %}selected{% endif %}>Есть продажа</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Период</label>
                        <select name="date" class="form-select">
                            <option value="">Все время</option>
                            <option value="today" {% if date_filter == 'today' %}selected{% endif %}>Сегодня</option>
                            <option value="week" {% if date_filter == 'week' %}selected{% endif %}>Неделя</option>
                            <option value="month" {% if date_filter == 'month' %}selected{% endif %}>Месяц</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-dark d-block w-100">
                            <i class="fas fa-filter"></i> Применить фильтры
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Список сообщений -->
<div class="row">
    <div class="col-12" id="messagesContainer">
        <!-- Индикатор загрузки -->
        <div class="text-center py-5" id="messagesLoader">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
            <p class="mt-3 text-muted">Загрузка сообщений...</p>
        </div>
        
        <!-- Контент сообщений (скрыт по умолчанию) -->
        <div id="messagesContent" style="display: none;">
        {% if page_obj %}
            {% for message in page_obj %}
            <div class="card mb-3 message-row status-{{ message.quality_status }} {% if not message.ai_approved %}bg-light{% endif %}"
                 data-message-id="{{ message.id }}"
                 data-username="{{ message.sender_username }}"
                 data-chat-name="{% if message.global_chat %}{{ message.global_chat.name }}{% endif %}"
                 data-message-text="{{ message.message_text|striptags }}">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-7">
                            <h5 class="card-title">
                                От: <strong>{{ message.sender_name|default:"Неизвестно" }}</strong>
                                {% if message.sender_username %} (@{{ message.sender_username }}){% endif %}
                                
                                <!-- Статус ИИ -->
                                {% if message.ai_approved %}
                                <span class="badge bg-success ms-2">Одобрено ИИ</span>
                                {% else %}
                                <span class="badge ms-2" style="background-color: #d7dde3; color: #000;">Отклонено ИИ</span>
                                {% endif %}
                            </h5>
                            <p class="card-text">{{ message.message_text|truncatewords:50 }}</p>
                            
                            <!-- Ключевые слова -->
                            <div class="mb-2">
                                <strong>Ключевые слова:</strong>
                                {% if message.matched_keywords %}
                                    {% for keyword in message.matched_keywords %}
                                    <span class="badge" style="background-color: #c4eedc; color: #000;">{{ keyword }}</span>
                                    {% endfor %}
                                {% else %}
                                <span class="text-muted">нет</span>
                                {% endif %}
                            </div>
                            
                            <small class="text-muted">
                                {{ message.processed_at|date:"d.m.Y H:i" }}
                                {% if message.global_chat %}
                    | 
                                    {% if message.global_chat.invite_link %}
                                        <a href="{{ message.global_chat.invite_link }}" target="_blank" class="text-decoration-none">{{ message.global_chat.name }}</a>
                                    {% else %}
                                        {{ message.global_chat.name }}
                                    {% endif %}
                                {% endif %}
                            </small>
                        </div>
                        <div class="col-md-5">
                            <div class="mb-2">
                                <div class="btn-group w-100 mb-2" role="group" aria-label="Quality status">
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-secondary {% if message.quality_status == 'unqualified' %}active{% endif %}"
                                            onclick="updateStatus({{ message.id }}, 'unqualified', this)">
                                        {% if message.quality_status == 'unqualified' %}✓{% endif %} Неквал
                                    </button>
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-secondary {% if message.quality_status == 'qualified' %}active{% endif %}"
                                            onclick="updateStatus({{ message.id }}, 'qualified', this)">
                                        {% if message.quality_status == 'qualified' %}✓{% endif %} Квал
                                    </button>
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-secondary {% if message.quality_status == 'spam' %}active{% endif %}"
                                            onclick="updateStatus({{ message.id }}, 'spam', this)">
                                        {% if message.quality_status == 'spam' %}✓{% endif %} Спам
                                    </button>
                                </div>
                                <div class="btn-group w-100 mb-2" role="group" aria-label="Progress status">
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-secondary {% if message.dialog_started %}active{% endif %}"
                                            onclick="updateProgress({{ message.id }}, 'dialog', {{ message.dialog_started|yesno:'true,false' }}, this)">
                                        {% if message.dialog_started %}✓{% endif %} Начали диалог
                                    </button>
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-secondary {% if message.sale_made %}active{% endif %}"
                                            onclick="updateProgress({{ message.id }}, 'sale', {{ message.sale_made|yesno:'true,false' }}, this)">
                                        {% if message.sale_made %}✓{% endif %} Есть продажа
                                    </button>
                                </div>
                            </div>
                            
                            <a href="{{ message.message_link|default:'#' }}" target="_blank" class="btn btn-sm btn-outline-primary w-100 mb-2" {% if not message.message_link %}disabled{% endif %}>
                                <i class="fas fa-external-link-alt"></i> Открыть в Telegram
                            </a>
                            
                            <!-- Кнопка отправки сообщения -->
                            {% if user.has_sender_account and message.sender_id %}
                            <button type="button" 
                                    class="btn btn-sm {% if message.message_sent %}btn-success{% else %}btn-outline-info{% endif %} w-100"
                                    onclick="openSendMessageModal({{ message.id }}, '{{ message.sender_name|escapejs }}', {{ message.message_sent|yesno:'true,false' }})">
                                {% if message.message_sent %}
                                <i class="fas fa-check"></i> Сообщение отправлено
                                {% else %}
                                <i class="fas fa-paper-plane"></i> Написать
                                {% endif %}
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            
            <!-- Пагинация -->
            {% if page_obj.has_other_pages %}
            <nav aria-label="Pagination" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if ai_status_filter %}&ai_status={{ ai_status_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if keyword_filter %}&keyword={{ keyword_filter }}{% endif %}{% if date_filter %}&date={{ date_filter }}{% endif %}{% if progress_filter %}&progress={{ progress_filter }}{% endif %}">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if ai_status_filter %}&ai_status={{ ai_status_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if keyword_filter %}&keyword={{ keyword_filter }}{% endif %}{% if date_filter %}&date={{ date_filter }}{% endif %}{% if progress_filter %}&progress={{ progress_filter }}{% endif %}">
                            <i class="fas fa-angle-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    <li class="page-item active">
                        <span class="page-link">
                            Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}
                        </span>
                    </li>

                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if ai_status_filter %}&ai_status={{ ai_status_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if keyword_filter %}&keyword={{ keyword_filter }}{% endif %}{% if date_filter %}&date={{ date_filter }}{% endif %}{% if progress_filter %}&progress={{ progress_filter }}{% endif %}">
                            <i class="fas fa-angle-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if ai_status_filter %}&ai_status={{ ai_status_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if keyword_filter %}&keyword={{ keyword_filter }}{% endif %}{% if date_filter %}&date={{ date_filter }}{% endif %}{% if progress_filter %}&progress={{ progress_filter }}{% endif %}">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Пока нет сообщений
            </div>
        {% endif %}
        </div><!-- Закрываем messagesContent -->
    </div>
</div>

<!-- Модальное окно для отправки сообщения -->
<div class="modal fade" id="sendMessageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-paper-plane"></i> Отправить сообщение
                    <span id="recipientName" class="text-muted"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="messageIdForSend">
                
                <!-- Выбор шаблона -->
                <div class="mb-3">
                    <label class="form-label">Выбрать шаблон</label>
                    <select class="form-select" id="templateSelect" onchange="loadTemplate()">
                        <option value="">-- Без шаблона --</option>
                        {% for template in user.message_templates.all %}
                        <option value="{{ template.id }}" {% if template.is_default %}selected{% endif %}>
                            {{ template.name }}{% if template.subject %} - {{ template.subject }}{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="form-text">
                        {% if user.message_templates.count == 0 %}
                        <a href="{% url 'dashboard:keyword_groups' %}" target="_blank">
                            Создать первую группу ключевых слов
                        </a>
                        {% else %}
                        <a href="{% url 'dashboard:keyword_groups' %}" target="_blank">
                            Управление ключевыми словами
                        </a>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Текст сообщения -->
                <div class="mb-3">
                    <label for="messageTextInput" class="form-label">Текст сообщения <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="messageTextInput" rows="10" required
                              placeholder="Введите текст сообщения..."></textarea>
                    <div class="form-text">
                        Доступные переменные: {name}, {username}, {chat_name}, {message_text}
                    </div>
                </div>
                
                <!-- Предпросмотр -->
                <div id="previewSection" style="display: none;">
                    <label class="form-label">Предпросмотр (с подстановкой переменных):</label>
                    <div class="bg-light p-3 rounded">
                        <pre id="messagePreview" class="mb-0" style="white-space: pre-wrap; font-family: inherit;"></pre>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="previewMessage()">
                    <i class="fas fa-eye"></i> Предпросмотр
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="sendMessageFromModal()">
                    <i class="fas fa-paper-plane"></i> Отправить
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Показываем контент после загрузки страницы
document.addEventListener('DOMContentLoaded', function() {
    // Небольшая задержка для визуального эффекта загрузки
    setTimeout(function() {
        document.getElementById('messagesLoader').style.display = 'none';
        document.getElementById('messagesContent').style.display = 'block';
    }, 300);
});

function updateStatus(messageId, status, button) {
    // Отправляем запрос на обновление статуса
    fetch(`/message/${messageId}/update-status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `quality_status=${status}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Обновляем UI - снимаем active со всех кнопок в группе и добавляем на текущую
            const btnGroup = button.parentElement;
            btnGroup.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('active');
                // Убираем галочку
                btn.textContent = btn.textContent.replace('✓ ', '');
            });
            // Добавляем active и галочку на текущую кнопку
            button.classList.add('active');
            if (!button.textContent.startsWith('✓')) {
                button.textContent = '✓ ' + button.textContent.trim();
            }
        } else {
            alert('Ошибка при обновлении статуса');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при обновлении статуса');
    });
}

function updateProgress(messageId, type, currentValue, button) {
    // Toggle значение
    const newValue = !currentValue;
    const field = type === 'dialog' ? 'dialog_started' : 'sale_made';
    
    fetch(`/message/${messageId}/update-status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `${field}=${newValue}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Toggle active класс и галочку
            if (newValue) {
                button.classList.add('active');
                if (!button.textContent.startsWith('✓')) {
                    button.textContent = '✓ ' + button.textContent.trim();
                }
            } else {
                button.classList.remove('active');
                button.textContent = button.textContent.replace('✓ ', '');
            }
            // Обновляем атрибут onclick с новым значением
            button.setAttribute('onclick', `updateProgress(${messageId}, '${type}', ${newValue}, this)`);
        } else {
            alert('Ошибка при обновлении статуса');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при обновлении статуса');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Функция для отправки сообщения
let currentMessageData = {};

function openSendMessageModal(messageId, senderName, alreadySent) {
    if (alreadySent) {
        if (!confirm('Сообщение уже было отправлено. Отправить еще раз?')) {
            return;
        }
    }
    
    // Сохраняем данные
    document.getElementById('messageIdForSend').value = messageId;
    document.getElementById('recipientName').textContent = `для ${senderName}`;
    
    // Находим данные сообщения на странице для переменных
    const messageCard = document.querySelector(`[data-message-id="${messageId}"]`);
    if (messageCard) {
        currentMessageData = {
            name: senderName,
            username: messageCard.dataset.username || '',
            chat_name: messageCard.dataset.chatName || '',
            message_text: messageCard.dataset.messageText || ''
        };
    }
    
    // Загружаем дефолтный шаблон если есть
    const templateSelect = document.getElementById('templateSelect');
    if (templateSelect.value) {
        loadTemplate();
    }
    
    // Открываем модальное окно
    const modal = new bootstrap.Modal(document.getElementById('sendMessageModal'));
    modal.show();
}

function loadTemplate() {
    const templateId = document.getElementById('templateSelect').value;
    if (!templateId) {
        document.getElementById('messageTextInput').value = '';
        return;
    }
    
    // Загружаем шаблон через AJAX
    fetch(`/templates/${templateId}/get/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('messageTextInput').value = data.text;
            }
        })
        .catch(error => {
            console.error('Error loading template:', error);
        });
}

function previewMessage() {
    const text = document.getElementById('messageTextInput').value;
    let preview = text;
    
    // Заменяем переменные
    for (const [key, value] of Object.entries(currentMessageData)) {
        preview = preview.replace(new RegExp(`\\{${key}\\}`, 'g'), value || `{${key}}`);
    }
    
    document.getElementById('messagePreview').textContent = preview;
    document.getElementById('previewSection').style.display = 'block';
}

function sendMessageFromModal() {
    const messageId = document.getElementById('messageIdForSend').value;
    const messageText = document.getElementById('messageTextInput').value.trim();
    
    if (!messageText) {
        alert('Введите текст сообщения');
        return;
    }
    
    // Отправляем сообщение
    fetch(`/message/${messageId}/send/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `message_text=${encodeURIComponent(messageText)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Сообщение успешно отправлено!');
            bootstrap.Modal.getInstance(document.getElementById('sendMessageModal')).hide();
            location.reload();
        } else {
            alert('Ошибка: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при отправке сообщения');
    });
}
</script>
{% endblock %}