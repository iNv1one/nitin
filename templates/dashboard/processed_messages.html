{% extends 'base.html' %}

{% block title %}–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è - NITIN{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="fas fa-envelope-open-text"></i> –°–æ–æ–±—â–µ–Ω–∏—è (CRM)</h2>
            <div>
                <span class="badge bg-primary">–í—Å–µ–≥–æ: {{ total_count }}</span>
                <span class="badge bg-success">‚úì –û–¥–æ–±—Ä–µ–Ω–æ –ò–ò: {{ approved_count }}</span>
                <span class="badge bg-danger">‚úó –û—Ç–∫–ª–æ–Ω–µ–Ω–æ –ò–ò: {{ rejected_count }}</span>
                <button class="btn btn-sm btn-outline-secondary" onclick="location.reload()">
                    <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label">–°—Ç–∞—Ç—É—Å –ò–ò</label>
                        <select name="ai_status" class="form-select">
                            <option value="">–í—Å–µ</option>
                            <option value="approved" {% if ai_status_filter == 'approved' %}selected{% endif %}>‚úì –û–¥–æ–±—Ä–µ–Ω–æ –ò–ò</option>
                            <option value="rejected" {% if ai_status_filter == 'rejected' %}selected{% endif %}>‚úó –û—Ç–∫–ª–æ–Ω–µ–Ω–æ –ò–ò</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">–ö–∞—á–µ—Å—Ç–≤–æ</label>
                        <select name="status" class="form-select">
                            <option value="">–í—Å–µ</option>
                            <option value="none" {% if status_filter == 'none' %}selected{% endif %}>‚ö™ –ù–µ–æ—Ç—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ</option>
                            <option value="qualified" {% if status_filter == 'qualified' %}selected{% endif %}>‚≠ê –ö–≤–∞–ª</option>
                            <option value="unqualified" {% if status_filter == 'unqualified' %}selected{% endif %}>‚ùå –ù–µ–∫–≤–∞–ª</option>
                            <option value="spam" {% if status_filter == 'spam' %}selected{% endif %}>üö´ –°–ø–∞–º</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">–î–∏–∞–ª–æ–≥/–ü—Ä–æ–¥–∞–∂–∞</label>
                        <select name="progress" class="form-select">
                            <option value="">–í—Å–µ</option>
                            <option value="dialog" {% if request.GET.progress == 'dialog' %}selected{% endif %}>üí¨ –î–∏–∞–ª–æ–≥ –Ω–∞—á–∞—Ç</option>
                            <option value="sale" {% if request.GET.progress == 'sale' %}selected{% endif %}>üí∞ –ï—Å—Ç—å –ø—Ä–æ–¥–∞–∂–∞</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">–ü–µ—Ä–∏–æ–¥</label>
                        <select name="date" class="form-select">
                            <option value="">–í—Å–µ –≤—Ä–µ–º—è</option>
                            <option value="today" {% if date_filter == 'today' %}selected{% endif %}>–°–µ–≥–æ–¥–Ω—è</option>
                            <option value="week" {% if date_filter == 'week' %}selected{% endif %}>–ù–µ–¥–µ–ª—è</option>
                            <option value="month" {% if date_filter == 'month' %}selected{% endif %}>–ú–µ—Å—è—Ü</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary d-block w-100">
                            <i class="fas fa-filter"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π -->
<div class="row">
    <div class="col-12">
        {% if page_obj %}
            {% for message in page_obj %}
            <div class="card mb-3 message-row status-{{ message.quality_status }} {% if not message.ai_approved %}bg-light{% endif %}"
                 data-message-id="{{ message.id }}"
                 data-username="{{ message.sender_username }}"
                 data-chat-name="{% if message.global_chat %}{{ message.global_chat.name }}{% endif %}"
                 data-message-text="{{ message.message_text|striptags }}">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-7">
                            <h5 class="card-title">
                                –û—Ç: <strong>{{ message.sender_name|default:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ" }}</strong>
                                {% if message.sender_username %} (@{{ message.sender_username }}){% endif %}
                                
                                <!-- –°—Ç–∞—Ç—É—Å –ò–ò -->
                                {% if message.ai_approved %}
                                <span class="badge bg-success ms-2"><i class="fas fa-robot"></i> ‚úì –û–¥–æ–±—Ä–µ–Ω–æ –ò–ò</span>
                                {% else %}
                                <span class="badge ms-2" style="background-color: #d7dde3; color: #000;">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ –ò–ò</span>
                                {% endif %}
                            </h5>
                            <p class="card-text">{{ message.message_text|truncatewords:50 }}</p>
                            
                            <!-- –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ -->
                            <div class="mb-2">
                                <strong><i class="fas fa-tags"></i> –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:</strong>
                                {% if message.matched_keywords %}
                                    {% for keyword in message.matched_keywords %}
                                    <span class="badge" style="background-color: #c4eedc; color: #000;">{{ keyword }}</span>
                                    {% endfor %}
                                {% else %}
                                <span class="text-muted">–Ω–µ—Ç</span>
                                {% endif %}
                            </div>
                            
                            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –ò–ò (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö) -->
                            {% if message.ai_approved and message.ai_result %}
                                <div class="alert alert-success alert-sm mb-2">
                                    <strong><i class="fas fa-robot"></i> –ò–ò:</strong> {{ message.ai_result|truncatewords:30 }}
                                    {% if message.ai_score %}
                                    <span class="badge bg-success ms-2">–û—Ü–µ–Ω–∫–∞: {{ message.ai_score|floatformat:2 }}</span>
                                    {% endif %}
                                </div>
                            {% endif %}
                            
                            <small class="text-muted">
                                <i class="fas fa-layer-group"></i> {{ message.keyword_group.name }} | 
                                <i class="fas fa-clock"></i> {{ message.date|date:"d.m.Y H:i" }}
                                {% if message.global_chat %}
                    | 
                                    {% if message.global_chat.invite_link %}
                                        <i class="fas fa-comments"></i> <a href="{{ message.global_chat.invite_link }}" target="_blank" class="text-decoration-none">{{ message.global_chat.name }}</a>
                                    {% else %}
                                        <i class="fas fa-comments"></i> {{ message.global_chat.name }}
                                    {% endif %}
                                {% endif %}
                            </small>
                        </div>
                        <div class="col-md-5">
                            <div class="mb-2">
                                <div class="btn-group w-100 mb-2" role="group" aria-label="Quality status">
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-secondary {% if message.quality_status == 'unqualified' %}active{% endif %}"
                                            onclick="updateStatus({{ message.id }}, 'unqualified', this)">
                                        {% if message.quality_status == 'unqualified' %}‚úì{% endif %} –ù–µ–∫–≤–∞–ª
                                    </button>
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-secondary {% if message.quality_status == 'qualified' %}active{% endif %}"
                                            onclick="updateStatus({{ message.id }}, 'qualified', this)">
                                        {% if message.quality_status == 'qualified' %}‚úì{% endif %} –ö–≤–∞–ª
                                    </button>
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-secondary {% if message.quality_status == 'spam' %}active{% endif %}"
                                            onclick="updateStatus({{ message.id }}, 'spam', this)">
                                        {% if message.quality_status == 'spam' %}‚úì{% endif %} –°–ø–∞–º
                                    </button>
                                </div>
                                <div class="btn-group w-100 mb-2" role="group" aria-label="Progress status">
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-secondary {% if message.dialog_started %}active{% endif %}"
                                            onclick="updateProgress({{ message.id }}, 'dialog', {{ message.dialog_started|yesno:'true,false' }}, this)">
                                        {% if message.dialog_started %}‚úì{% endif %} –ù–∞—á–∞–ª–∏ –¥–∏–∞–ª–æ–≥
                                    </button>
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-secondary {% if message.sale_made %}active{% endif %}"
                                            onclick="updateProgress({{ message.id }}, 'sale', {{ message.sale_made|yesno:'true,false' }}, this)">
                                        {% if message.sale_made %}‚úì{% endif %} –ï—Å—Ç—å –ø—Ä–æ–¥–∞–∂–∞
                                    </button>
                                </div>
                            </div>
                            
                            {% if message.message_link %}
                            <a href="{{ message.message_link }}" target="_blank" class="btn btn-sm btn-outline-primary w-100 mb-2">
                                <i class="fas fa-external-link-alt"></i> –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
                            </a>
                            {% endif %}
                            
                            <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                            {% if user.has_sender_account and message.sender_id %}
                            <button type="button" 
                                    class="btn btn-sm {% if message.message_sent %}btn-success{% else %}btn-outline-info{% endif %} w-100"
                                    onclick="openSendMessageModal({{ message.id }}, '{{ message.sender_name|escapejs }}', {{ message.message_sent|yesno:'true,false' }})">
                                {% if message.message_sent %}
                                <i class="fas fa-check"></i> –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
                                {% else %}
                                <i class="fas fa-paper-plane"></i> –ù–∞–ø–∏—Å–∞—Ç—å
                                {% endif %}
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            
            <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
            {% if page_obj.has_other_pages %}
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if ai_status_filter %}&ai_status={{ ai_status_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if keyword_filter %}&keyword={{ keyword_filter }}{% endif %}{% if date_filter %}&date={{ date_filter }}{% endif %}{% if progress_filter %}&progress={{ progress_filter }}{% endif %}">–ü–µ—Ä–≤–∞—è</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if ai_status_filter %}&ai_status={{ ai_status_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if keyword_filter %}&keyword={{ keyword_filter }}{% endif %}{% if date_filter %}&date={{ date_filter }}{% endif %}{% if progress_filter %}&progress={{ progress_filter }}{% endif %}">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
                    </li>
                    {% endif %}

                    <li class="page-item active">
                        <span class="page-link">
                            –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}
                        </span>
                    </li>

                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if ai_status_filter %}&ai_status={{ ai_status_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if keyword_filter %}&keyword={{ keyword_filter }}{% endif %}{% if date_filter %}&date={{ date_filter }}{% endif %}{% if progress_filter %}&progress={{ progress_filter }}{% endif %}">–°–ª–µ–¥—É—é—â–∞—è</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if ai_status_filter %}&ai_status={{ ai_status_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if keyword_filter %}&keyword={{ keyword_filter }}{% endif %}{% if date_filter %}&date={{ date_filter }}{% endif %}{% if progress_filter %}&progress={{ progress_filter }}{% endif %}">–ü–æ—Å–ª–µ–¥–Ω—è—è</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> –ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
            </div>
        {% endif %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -->
<div class="modal fade" id="sendMessageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                    <span id="recipientName" class="text-muted"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="messageIdForSend">
                
                <!-- –í—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞ -->
                <div class="mb-3">
                    <label class="form-label">–í—ã–±—Ä–∞—Ç—å —à–∞–±–ª–æ–Ω</label>
                    <select class="form-select" id="templateSelect" onchange="loadTemplate()">
                        <option value="">-- –ë–µ–∑ —à–∞–±–ª–æ–Ω–∞ --</option>
                        {% for template in user.message_templates.all %}
                        <option value="{{ template.id }}" {% if template.is_default %}selected{% endif %}>
                            {{ template.name }}{% if template.subject %} - {{ template.subject }}{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="form-text">
                        {% if user.message_templates.count == 0 %}
                        <a href="{% url 'dashboard:message_templates' %}" target="_blank">
                            –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π —à–∞–±–ª–æ–Ω
                        </a>
                        {% else %}
                        <a href="{% url 'dashboard:message_templates' %}" target="_blank">
                            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞–º–∏
                        </a>
                        {% endif %}
                    </div>
                </div>
                
                <!-- –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è -->
                <div class="mb-3">
                    <label for="messageTextInput" class="form-label">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="messageTextInput" rows="10" required
                              placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..."></textarea>
                    <div class="form-text">
                        –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: {name}, {username}, {chat_name}, {message_text}
                    </div>
                </div>
                
                <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
                <div id="previewSection" style="display: none;">
                    <label class="form-label">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä (—Å –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö):</label>
                    <div class="bg-light p-3 rounded">
                        <pre id="messagePreview" class="mb-0" style="white-space: pre-wrap; font-family: inherit;"></pre>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="previewMessage()">
                    <i class="fas fa-eye"></i> –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="sendMessageFromModal()">
                    <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function updateStatus(messageId, status, button) {
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
    fetch(`/message/${messageId}/update-status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `quality_status=${status}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º UI - —Å–Ω–∏–º–∞–µ–º active —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –≤ –≥—Ä—É–ø–ø–µ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–∞ —Ç–µ–∫—É—â—É—é
            const btnGroup = button.parentElement;
            btnGroup.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('active');
                // –£–±–∏—Ä–∞–µ–º –≥–∞–ª–æ—á–∫—É
                btn.textContent = btn.textContent.replace('‚úì ', '');
            });
            // –î–æ–±–∞–≤–ª—è–µ–º active –∏ –≥–∞–ª–æ—á–∫—É –Ω–∞ —Ç–µ–∫—É—â—É—é –∫–Ω–æ–ø–∫—É
            button.classList.add('active');
            if (!button.textContent.startsWith('‚úì')) {
                button.textContent = '‚úì ' + button.textContent.trim();
            }
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
    });
}

function updateProgress(messageId, type, currentValue, button) {
    // Toggle –∑–Ω–∞—á–µ–Ω–∏–µ
    const newValue = !currentValue;
    const field = type === 'dialog' ? 'dialog_started' : 'sale_made';
    
    fetch(`/message/${messageId}/update-status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `${field}=${newValue}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Toggle active –∫–ª–∞—Å—Å –∏ –≥–∞–ª–æ—á–∫—É
            if (newValue) {
                button.classList.add('active');
                if (!button.textContent.startsWith('‚úì')) {
                    button.textContent = '‚úì ' + button.textContent.trim();
                }
            } else {
                button.classList.remove('active');
                button.textContent = button.textContent.replace('‚úì ', '');
            }
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç onclick —Å –Ω–æ–≤—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
            button.setAttribute('onclick', `updateProgress(${messageId}, '${type}', ${newValue}, this)`);
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
let currentMessageData = {};

function openSendMessageModal(messageId, senderName, alreadySent) {
    if (alreadySent) {
        if (!confirm('–°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –µ—â–µ —Ä–∞–∑?')) {
            return;
        }
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
    document.getElementById('messageIdForSend').value = messageId;
    document.getElementById('recipientName').textContent = `–¥–ª—è ${senderName}`;
    
    // –ù–∞—Ö–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
    const messageCard = document.querySelector(`[data-message-id="${messageId}"]`);
    if (messageCard) {
        currentMessageData = {
            name: senderName,
            username: messageCard.dataset.username || '',
            chat_name: messageCard.dataset.chatName || '',
            message_text: messageCard.dataset.messageText || ''
        };
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —à–∞–±–ª–æ–Ω –µ—Å–ª–∏ –µ—Å—Ç—å
    const templateSelect = document.getElementById('templateSelect');
    if (templateSelect.value) {
        loadTemplate();
    }
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = new bootstrap.Modal(document.getElementById('sendMessageModal'));
    modal.show();
}

function loadTemplate() {
    const templateId = document.getElementById('templateSelect').value;
    if (!templateId) {
        document.getElementById('messageTextInput').value = '';
        return;
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —à–∞–±–ª–æ–Ω —á–µ—Ä–µ–∑ AJAX
    fetch(`/templates/${templateId}/get/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('messageTextInput').value = data.text;
            }
        })
        .catch(error => {
            console.error('Error loading template:', error);
        });
}

function previewMessage() {
    const text = document.getElementById('messageTextInput').value;
    let preview = text;
    
    // –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    for (const [key, value] of Object.entries(currentMessageData)) {
        preview = preview.replace(new RegExp(`\\{${key}\\}`, 'g'), value || `{${key}}`);
    }
    
    document.getElementById('messagePreview').textContent = preview;
    document.getElementById('previewSection').style.display = 'block';
}

function sendMessageFromModal() {
    const messageId = document.getElementById('messageIdForSend').value;
    const messageText = document.getElementById('messageTextInput').value.trim();
    
    if (!messageText) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è');
        return;
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    fetch(`/message/${messageId}/send/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `message_text=${encodeURIComponent(messageText)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
            bootstrap.Modal.getInstance(document.getElementById('sendMessageModal')).hide();
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
    });
}
</script>
{% endblock %}