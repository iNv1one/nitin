{% extends 'base.html' %}

{% block title %}–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è - NITIN{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-envelope-open-text"></i> –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (CRM)</h2>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                        <select name="status" class="form-select">
                            <option value="">–í—Å–µ</option>
                            <option value="new" {% if status_filter == 'new' %}selected{% endif %}>–ù–æ–≤—ã–µ</option>
                            <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>–í —Ä–∞–±–æ—Ç–µ</option>
                            <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>–ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                            <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">–ü–µ—Ä–∏–æ–¥</label>
                        <select name="date" class="form-select">
                            <option value="">–í—Å–µ –≤—Ä–µ–º—è</option>
                            <option value="today" {% if date_filter == 'today' %}selected{% endif %}>–°–µ–≥–æ–¥–Ω—è</option>
                            <option value="week" {% if date_filter == 'week' %}selected{% endif %}>–ù–µ–¥–µ–ª—è</option>
                            <option value="month" {% if date_filter == 'month' %}selected{% endif %}>–ú–µ—Å—è—Ü</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary d-block w-100">
                            <i class="fas fa-filter"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π -->
<div class="row">
    <div class="col-12">
        {% if page_obj %}
            {% for message in page_obj %}
            <div class="card mb-3 message-row status-{{ message.crm_status }}">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="card-title">
                                –û—Ç: <strong>{{ message.sender_name|default:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ" }}</strong>
                                {% if message.sender_username %} (@{{ message.sender_username }}){% endif %}
                            </h5>
                            <p class="card-text">{{ message.message_text|truncatewords:50 }}</p>
                            <small class="text-muted">
                                <i class="fas fa-tags"></i> {{ message.matched_keywords_display }} | 
                                <i class="fas fa-clock"></i> {{ message.processed_at|date:"d.m.Y H:i" }}
                            </small>
                        </div>
                        <div class="col-md-4">
                            <form method="post" action="{% url 'dashboard:update_message_status' message.id %}">
                                {% csrf_token %}
                                <select name="status" class="form-select mb-2" onchange="this.form.submit()">
                                    <option value="new" {% if message.crm_status == 'new' %}selected{% endif %}>üÜï –ù–æ–≤–æ–µ</option>
                                    <option value="in_progress" {% if message.crm_status == 'in_progress' %}selected{% endif %}>‚è≥ –í —Ä–∞–±–æ—Ç–µ</option>
                                    <option value="completed" {% if message.crm_status == 'completed' %}selected{% endif %}>‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                                    <option value="rejected" {% if message.crm_status == 'rejected' %}selected{% endif %}>‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ</option>
                                </select>
                            </form>
                            {% if message.message_link %}
                            <a href="{{ message.message_link }}" target="_blank" class="btn btn-sm btn-outline-primary w-100">
                                <i class="fas fa-external-link-alt"></i> –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> –ü–æ–∫–∞ –Ω–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}
