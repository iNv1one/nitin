# Настройка Sender-аккаунта для отправки сообщений

## Описание
Система поддерживает два типа Telegram аккаунтов:
1. **Parser-аккаунт** - только читает сообщения из чатов (основной функционал)
2. **Sender-аккаунт** - отправляет сообщения лидам от вашего имени

## Как настроить Sender-аккаунт

### Шаг 1: Получить API credentials
1. Перейдите на https://my.telegram.org
2. Войдите с помощью ОТДЕЛЬНОГО аккаунта (не parser-аккаунт!)
3. Перейдите в "API development tools"
4. Создайте приложение и получите:
   - `api_id` (числовой ID)
   - `api_hash` (строка)

### Шаг 2: Создать session string
Запустите скрипт для создания session string:

```python
from telethon import TelegramClient
from telethon.sessions import StringSession

api_id = YOUR_API_ID  # Замените на ваш api_id
api_hash = 'YOUR_API_HASH'  # Замените на ваш api_hash
phone = '+1234567890'  # Замените на номер телефона аккаунта

client = TelegramClient(StringSession(), api_id, api_hash)

async def main():
    await client.start(phone)
    print("Session string:")
    print(client.session.save())

with client:
    client.loop.run_until_complete(main())
```

Это выведет session string - длинную строку символов. Сохраните её!

### Шаг 3: Добавить данные в админку Django
1. Зайдите в админку: `https://yoursite.com/admin/`
2. Откройте пользователя
3. Заполните поля:
   - **Sender API ID**: ваш api_id
   - **Sender API Hash**: ваш api_hash
   - **Sender Phone**: номер телефона в формате +1234567890
   - **Sender Session**: session string из шага 2

### Шаг 4: (Опционально) Настроить шаблон сообщения
В поле **"Шаблон сообщения по умолчанию"** укажите текст, например:
```
Здравствуйте, {name}! 

Увидел ваше сообщение и хочу предложить...
```

Переменные:
- `{name}` - будет заменено на имя получателя

## Как использовать

### На странице Сообщения
1. Откройте раздел "Сообщения"
2. Найдите лид, которому хотите написать
3. Нажмите кнопку **"Написать"**
4. Введите текст сообщения (или используйте шаблон)
5. Сообщение будет отправлено от имени sender-аккаунта

### Статус отправки
- Зеленая кнопка "Сообщение отправлено" - уже отправлено
- Синяя кнопка "Написать" - еще не отправлено

## Важно!
⚠️ **Безопасность:**
- Используйте РАЗНЫЕ аккаунты для парсинга и отправки
- Не отправляйте спам - это может привести к бану
- Соблюдайте лимиты Telegram (не более 40-50 сообщений в час новым контактам)

⚠️ **Рекомендации:**
- Персонализируйте сообщения
- Используйте переменные в шаблонах
- Не отправляйте одинаковый текст всем
- Делайте паузы между отправками

## Troubleshooting

### Ошибка "Sender-аккаунт не настроен"
- Проверьте, что все 4 поля заполнены в админке
- Убедитесь, что session string корректный

### Ошибка "У этого сообщения нет ID отправителя"
- Некоторые сообщения не содержат ID отправителя (например, из каналов)
- Кнопка "Написать" будет доступна только для сообщений с ID

### Сообщение не отправляется
1. Проверьте логи: `tail -f logs/django.log`
2. Убедитесь, что sender-аккаунт не заблокирован
3. Проверьте, что получатель не заблокировал sender-аккаунт
4. Попробуйте отправить сообщение вручную из Telegram

## Структура базы данных

### Новые поля в User:
- `sender_api_id` - API ID отправителя
- `sender_api_hash` - API Hash отправителя
- `sender_phone` - телефон отправителя
- `sender_session_string` - session string
- `default_message_template` - шаблон по умолчанию

### Новые поля в ProcessedMessage:
- `message_sent` - флаг отправки
- `message_sent_at` - дата отправки
- `sent_message_text` - текст отправленного сообщения
